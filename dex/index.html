<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BitSoley Swap</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b0f17; color: #e6edf3; }
    header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f2633; }
    .brand { font-weight: 700; letter-spacing: .5px; }
    .card { background: #111827; border: 1px solid #1f2633; border-radius: 14px; padding: 16px; max-width: 520px; margin: 24px auto; }
    .row { display: flex; gap: 12px; margin: 10px 0; align-items: center; }
    input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #263040; background: #0b1220; color: #e6edf3; font-size: 16px; }
    button { padding: 12px 16px; border-radius: 12px; border: 1px solid #2a3344; background: #1a2233; color: #e6edf3; cursor: pointer; }
    button:hover { filter: brightness(1.1); }
    .muted { color: #90a0b7; font-size: 14px; }
    .pill { padding: 4px 8px; border: 1px solid #2a3344; border-radius: 999px; }
    .center { text-align: center; }
    a { color: #7cc4ff; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">BitSoley Swap</div>
    <div>
      <button id="btnAdd">Add BitSoley Network</button>
      <button id="btnConnect">Connect Wallet</button>
    </div>
  </header>
  <div class="card">
    <div class="row">
      <div class="pill">WBSO</div><div class="muted">Wrapped BSO balance:</div><div id="balWBSO" class="pill">-</div>
    </div>
    <div class="grid">
      <div>
        <div class="muted small">BSO → Token</div>
        <input id="amtBSO" placeholder="Amount in BSO">
        <button id="btnSwapBSO">Swap BSO → Token</button>
      </div>
      <div>
        <div class="muted small">Token → BSO</div>
        <input id="amtTKN" placeholder="Amount in Token">
        <button id="btnSwapTKN">Swap Token → BSO</button>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid #1f2633;margin:18px 0" />

    <div class="grid">
      <div>
        <div class="muted small">Wrap</div>
        <input id="amtWrap" placeholder="BSO to wrap">
        <button id="btnWrap">Wrap BSO → WBSO</button>
      </div>
      <div>
        <div class="muted small">Unwrap</div>
        <input id="amtUnwrap" placeholder="WBSO to unwrap">
        <button id="btnUnwrap">Unwrap WBSO → BSO</button>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid #1f2633;margin:18px 0" />

    <div>
      <div class="muted small">Add Liquidity (Token & WBSO)</div>
      <input id="amtAddT" placeholder="Token amount">
      <input id="amtAddW" placeholder="WBSO amount">
      <button id="btnAddLiq">Add Liquidity</button>
    </div>
    <div class="row">
      <div class="muted">Your LP balance:</div> <div id="balLP" class="pill">-</div>
      <input id="amtRmv" placeholder="LP amount to remove">
      <button id="btnRmvLiq">Remove Liquidity</button>
    </div>

    <div class="center muted small" id="status">Status: Not connected</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.min.js"></script>
  <script src="./config.js"></script>
  <script>
    // Minimal ABIs
    const ABI_IERC20 = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint)",
      "function allowance(address,address) view returns (uint)",
      "function approve(address,uint) returns (bool)",
      "function transfer(address,uint) returns (bool)"
    ];
    const ABI_WBSO = [
      ...ABI_IERC20,
      "function deposit() payable",
      "function withdraw(uint)"
    ];
    const ABI_ROUTER = [
      "function pair() view returns (address)",
      "function wbs() view returns (address)",
      "function addLiquidity(uint,uint,address)",
      "function removeLiquidity(uint,address)",
      "function swapExactBSOForTokens(uint,address) payable",
      "function swapExactTokensForBSO(address,uint,uint,address)"
    ];
    const ABI_PAIR = [
      "function getReserves() view returns (uint112,uint112,uint32)",
      "function balanceOf(address) view returns (uint)",
      "function approve(address,uint) returns (bool)"
    ];

    const BITSOLEY = {
      chainId: "0x34E91",
      chainName: "BitSoley",
      rpcUrls: ["https://rpc.bitsoley.com"],
      nativeCurrency: { name: "BitSoley", symbol: "BSO", decimals: 18 },
      blockExplorerUrls: []
    };

    let provider, signer, accounts;
    let router, wbso, token, pair;

    function $(id){ return document.getElementById(id); }
    function fmt(x, dec=18){ return Number(ethers.formatUnits(x, dec)).toLocaleString(); }

    async function ensureNetwork() {
      const current = await window.ethereum.request({ method: "eth_chainId" });
      if (current !== BITSOLEY.chainId) {
        await window.ethereum.request({ method: "wallet_addEthereumChain", params: [BITSOLEY] });
      }
    }

    async function connect() {
      await ensureNetwork();
      provider = new ethers.BrowserProvider(window.ethereum);
      accounts = await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      router = new ethers.Contract(CONFIG.ROUTER_ADDRESS, ABI_ROUTER, signer);
      wbso   = new ethers.Contract(CONFIG.WBSO_ADDRESS, ABI_WBSO, signer);
      token  = new ethers.Contract(CONFIG.TOKEN_ADDRESS, ABI_IERC20, signer);
      const pairAddr = await router.pair();
      pair   = new ethers.Contract(pairAddr, ABI_PAIR, signer);
      $("status").innerText = "Connected: " + accounts[0];
      refresh();
    }

    async function refresh() {
      if (!signer) return;
      const [balW, balLP] = await Promise.all([
        wbso.balanceOf(accounts[0]),
        pair.balanceOf(accounts[0])
      ]);
      $("balWBSO").innerText = fmt(balW);
      $("balLP").innerText = fmt(balLP);
    }

    async function addNetwork(){ await ensureNetwork(); }

    async function wrap() {
      const amt = ethers.parseEther($("amtWrap").value || "0");
      const tx = await wbso.deposit({ value: amt });
      $("status").innerText = "Wrapping...";
      await tx.wait();
      $("status").innerText = "Wrapped " + ethers.formatEther(amt) + " BSO";
      refresh();
    }

    async function unwrap() {
      const amt = ethers.parseUnits($("amtUnwrap").value || "0", 18);
      const tx = await wbso.withdraw(amt);
      $("status").innerText = "Unwrapping...";
      await tx.wait();
      $("status").innerText = "Unwrapped";
      refresh();
    }

    async function swapBSO() {
      const amt = ethers.parseEther($("amtBSO").value || "0");
      const tx = await router.swapExactBSOForTokens(0, accounts[0], { value: amt });
      $("status").innerText = "Swapping BSO -> Token ...";
      await tx.wait();
      $("status").innerText = "Swap complete";
      refresh();
    }

    async function swapTKN() {
      const amt = ethers.parseUnits($("amtTKN").value || "0", 18);
      // approve router first if needed
      const allowance = await token.allowance(accounts[0], CONFIG.ROUTER_ADDRESS);
      if (allowance < amt) {
        await (await token.approve(CONFIG.ROUTER_ADDRESS, ethers.MaxUint256)).wait();
      }
      const tx = await router.swapExactTokensForBSO(CONFIG.TOKEN_ADDRESS, amt, 0, accounts[0]);
      $("status").innerText = "Swapping Token -> BSO ...";
      await tx.wait();
      $("status").innerText = "Swap complete";
      refresh();
    }

    async function addLiq() {
      const amtT = ethers.parseUnits($("amtAddT").value || "0", 18);
      const amtW = ethers.parseUnits($("amtAddW").value || "0", 18);
      const [ar1, ar2] = await Promise.all([
        token.approve(CONFIG.ROUTER_ADDRESS, ethers.MaxUint256),
        wbso.approve(CONFIG.ROUTER_ADDRESS, ethers.MaxUint256)
      ]);
      await ar1.wait(); await ar2.wait();
      const tx = await router.addLiquidity(amtT, amtW, accounts[0]);
      $("status").innerText = "Adding liquidity...";
      await tx.wait();
      $("status").innerText = "Liquidity added";
      refresh();
    }

    async function rmvLiq() {
      const amt = ethers.parseUnits($("amtRmv").value || "0", 18);
      // approve pair (LP) to router first
      await (await pair.approve(CONFIG.ROUTER_ADDRESS, ethers.MaxUint256)).wait();
      const tx = await router.removeLiquidity(amt, accounts[0]);
      $("status").innerText = "Removing liquidity...";
      await tx.wait();
      $("status").innerText = "Liquidity removed";
      refresh();
    }

    $("btnConnect").onclick = connect;
    $("btnAdd").onclick = addNetwork;
    $("btnWrap").onclick = wrap;
    $("btnUnwrap").onclick = unwrap;
    $("btnSwapBSO").onclick = swapBSO;
    $("btnSwapTKN").onclick = swapTKN;
    $("btnAddLiq").onclick = addLiq;
    $("btnRmvLiq").onclick = rmvLiq;
  </script>
</body>
</html>
