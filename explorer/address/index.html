<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BitSoley Explorer — Address</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<style>
:root{--bg1:#020217;--bg2:#061237;--accent1:#6bc8ff;--accent2:#38f9d7;--muted:#98adc0}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#e6f7ff}
.container{max-width:1000px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
.brand{font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.controls{display:flex;gap:8px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.btn{padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.03);color:var(--accent1);font-weight:700;cursor:pointer}
.card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
.small{font-size:13px;color:var(--muted)}
.mono{font-family:ui-monospace,monospace;color:#bfeff8}
@media(max-width:800px){ .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div><div class="brand">BitSoley Explorer</div><div class="small">Address • RPC: <span id="rpcHost">—</span></div></div>
      <div class="controls">
        <input id="addrInput" class="input" placeholder="0x..." />
        <button id="viewBtn" class="btn">View</button>
        <button id="connectBtn" class="btn"><i class="fa fa-wallet"></i>&nbsp;<span id="connectLabel">Connect</span></button>
        <button id="addNetworkBtn" class="btn">Add Network</button>
      </div>
    </div>

    <div id="card" class="card">
      <div id="status" class="small">Ready</div>
      <div id="addressArea" style="margin-top:12px"></div>
    </div>
  </div>

<script>
const RPC_BASE = 'https://rpc.bitsoley.com';
const CHAIN_ID_DEC = 216721;
const CHAIN_ID_HEX = '0x34e91';
const SYMBOL = 'BSO';
document.getElementById('rpcHost').innerText = (()=>{ try{return new URL(RPC_BASE).hostname}catch(e){return RPC_BASE}})();

const provider = new ethers.providers.JsonRpcProvider(RPC_BASE);
let walletProvider=null, signer=null, walletAddress=null;
const short = s => s ? (s.slice(0,8)+'…'+s.slice(-6)) : '';
const getBasePath = () => window.location.pathname.includes('/explorer/') ? '/explorer' : '';

async function connectWallet(){ if (window.ethereum){ try{ await window.ethereum.request({method:'eth_requestAccounts'}); walletProvider = new ethers.providers.Web3Provider(window.ethereum); signer = walletProvider.getSigner(); walletAddress = await signer.getAddress(); document.getElementById('connectLabel').innerText = short(walletAddress); }catch(e){console.error(e);alert('MetaMask failed')} return;} try{ const wc = new window.WalletConnectProvider.default({ rpc: { [CHAIN_ID_DEC]: RPC_BASE }, qrcode:true }); await wc.enable(); walletProvider = new ethers.providers.Web3Provider(wc); signer = walletProvider.getSigner(); walletAddress = await signer.getAddress(); document.getElementById('connectLabel').innerText = short(walletAddress); wc.on('disconnect', ()=>{ walletProvider=null; signer=null; walletAddress=null; document.getElementById('connectLabel').innerText='Connect'; }); }catch(e){ console.error(e); alert('WalletConnect failed'); } }
document.getElementById('connectBtn').addEventListener('click', connectWallet);
document.getElementById('addNetworkBtn').addEventListener('click', async ()=>{ if (!window.ethereum) return alert('Install MetaMask'); try{ await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: CHAIN_ID_HEX, chainName:'BitSoley', rpcUrls:[RPC_BASE], nativeCurrency:{name:'BitSoley',symbol:SYMBOL,decimals:18}, blockExplorerUrls:[ window.location.origin + getBasePath() ] }]}); alert('Network added'); }catch(e){ console.error(e); alert('Add network failed'); } });

function extractAddress(){
  const parts = window.location.pathname.split('/').filter(Boolean);
  for (let i=0;i<parts.length;i++){ if (parts[i].toLowerCase()==='address' && parts[i+1]) return parts[i+1]; }
  const last = parts[parts.length-1]; if (/^0x[0-9a-fA-F]{40}$/.test(last)) return last; return null;
}

document.getElementById('viewBtn').addEventListener('click', ()=> {
  const val = document.getElementById('addrInput').value.trim();
  if (!val) return alert('Enter address');
  showAddress(val);
});

async function showAddress(addr){
  try{
    if (!/^0x[0-9a-fA-F]{40}$/.test(addr)) { alert('Invalid address'); return; }
    document.getElementById('status').innerText = 'Fetching balance...';
    const balance = await provider.getBalance(addr);
    const human = ethers.utils.formatEther(balance);
    document.getElementById('addressArea').innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div style="flex:1">
          <div class="small">Address</div><div class="mono" style="margin-top:6px">${addr}</div>
          <div class="small" style="margin-top:8px">Use 'Scan recent blocks' to find transactions (best-effort)</div>
        </div>
        <div style="width:260px;text-align:right">
          <div class="small">Balance</div><div style="font-weight:800;margin-top:8px">${Number(human).toFixed(6)} ${SYMBOL}</div>
          <div style="margin-top:8px"><button class="btn" onclick="navigator.clipboard.writeText('${addr}').then(()=>alert('Copied'))">Copy</button> <button class="btn" onclick="window.open('${window.location.origin + getBasePath()}/address/${addr}')">Open</button></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="scanCount" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:120px" placeholder="blocks (200)" value="200">
          <button id="scanBtn" class="btn">Scan Recent</button>
        </div>
        <div id="scanProgress" class="small" style="margin-top:8px"></div>
        <div id="txsFound" style="margin-top:12px"></div>
      </div>
    `;
    document.getElementById('status').innerText = '';
    document.getElementById('scanBtn').addEventListener('click', ()=> scanRecent(addr, Number(document.getElementById('scanCount').value || 200)));
  }catch(e){
    console.error(e);
    document.getElementById('status').innerText = 'Error: ' + (e.message||e);
  }
}

async function scanRecent(addr, blocksToScan=200){
  addr = addr.toLowerCase();
  const latest = await provider.getBlockNumber();
  const end = Math.max(0, latest - blocksToScan + 1);
  const found = [];
  document.getElementById('scanProgress').innerText = `Scanning ${latest} → ${end} ...`;
  for (let b = latest; b>=end; b--){
    try{
      const blk = await provider.getBlockWithTransactions(b);
      for (const tx of blk.transactions){
        if ((tx.from && tx.from.toLowerCase()===addr) || (tx.to && tx.to.toLowerCase()===addr)){
          found.push({ hash: tx.hash, value: ethers.utils.formatEther(tx.value || 0), block: blk.number, from: tx.from, to: tx.to });
        }
      }
      if ((latest - b) % 20 === 0) document.getElementById('scanProgress').innerText = `Scanning ${latest} → ${end} ... (${latest - b}/${blocksToScan})`;
    }catch(err){
      console.warn('block fetch failed', b, err);
    }
  }
  document.getElementById('scanProgress').innerText = `Scan complete — found ${found.length} tx(s)`;
  const container = document.getElementById('txsFound');
  if (!found.length) { container.innerHTML = '<div class="small">No transactions found in that range (best-effort).</div>'; return; }
  container.innerHTML = found.map(r => `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><div><div class="mono">${r.hash}</div><div class="small">${r.from} → ${r.to}</div></div><div style="text-align:right"><div style="font-weight:800">${Number(r.value).toFixed(6)} ${SYMBOL}</div><div style="margin-top:8px"><button class="btn" onclick="window.location.href='${getBasePath()}/tx/${r.hash}'">View</button></div></div></div>`).join('');
}

/* boot */
(function boot(){
  const a = extractAddress();
  if (a){ document.getElementById('addrInput').value = a; showAddress(a); } else { document.getElementById('status').innerText = 'Enter an address or open /address/0x...'; }
})();
function extractAddress(){ const parts = window.location.pathname.split('/').filter(Boolean); for (let i=0;i<parts.length;i++){ if (parts[i].toLowerCase()==='address' && parts[i+1]) return parts[i+1]; } const last = parts[parts.length-1]; if (/^0x[0-9a-fA-F]{40}$/.test(last)) return last; return null; }
</script>
</body>
</html>
