<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BitSoley Explorer — Transaction</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Ethers (v5 UMD) + WalletConnect provider (optional) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

<style>
:root{
  --bg1:#020217; --bg2:#061237;
  --accent1:#6bc8ff; --accent2:#38f9d7;
  --muted:#98adc0; --glass: rgba(255,255,255,0.04);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  color: #e6f7ff;
}
html,body{height:100%;margin:0;background:
  radial-gradient(800px 400px at 10% 15%, rgba(180,0,255,0.04), transparent),
  linear-gradient(180deg,var(--bg1),var(--bg2)); -webkit-font-smoothing:antialiased;}
.shell{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
.brand{font-weight:800;font-size:1.2rem;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:var(--accent1);font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041226}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(0,0,0,0.45)}
.mono{font-family:ui-monospace,monospace;color:#bfeff8}
.small{font-size:13px;color:var(--muted)}
@media(max-width:800px){ .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div>
        <div class="brand">BitSoley Explorer</div>
        <div class="small">Transaction details • RPC: <span id="rpcHost">—</span></div>
      </div>

      <div class="controls">
        <button id="connectBtn" class="btn primary"><i class="fa fa-wallet"></i>&nbsp;<span id="connectLabel">Connect</span></button>
        <button id="addNetworkBtn" class="btn">Add BitSoley</button>
        <button id="copyUrlBtn" class="btn">Copy URL</button>
      </div>
    </div>

    <div id="content" class="card">
      <div id="status" class="small">Loading transaction...</div>
      <div id="txArea" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const RPC_BASE = 'https://rpc.bitsoley.com';
const CHAIN_ID_DEC = 216721;
const CHAIN_ID_HEX = '0x34e91';
const SYMBOL = 'BSO';
/* ================== */

document.getElementById('rpcHost').innerText = (()=>{ try{return new URL(RPC_BASE).hostname}catch(e){return RPC_BASE}})();

let provider = new ethers.providers.JsonRpcProvider(RPC_BASE);
let walletProvider = null; // ethers provider from wallet (if connected)
let signer = null;
let walletAddress = null;

const short = s => s ? (s.slice(0,8)+"…"+s.slice(-6)) : '';
const getExplorerBase = () => (window.location.pathname.includes('/explorer/') ? '/explorer' : '');

/* Wallet connect (MetaMask + WalletConnect v1) */
async function connectWallet(){
  if (window.ethereum){
    try{
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      walletProvider = new ethers.providers.Web3Provider(window.ethereum);
      signer = walletProvider.getSigner();
      walletAddress = await signer.getAddress();
      document.getElementById('connectLabel').innerText = short(walletAddress);
    }catch(e){ console.error(e); alert('MetaMask connect failed: '+(e.message||e)) }
    return;
  }
  // fallback: WalletConnect (QR)
  try{
    const wc = new window.WalletConnectProvider.default({ rpc: { [CHAIN_ID_DEC]: RPC_BASE }, qrcode: true });
    await wc.enable();
    walletProvider = new ethers.providers.Web3Provider(wc);
    signer = walletProvider.getSigner();
    walletAddress = await signer.getAddress();
    document.getElementById('connectLabel').innerText = short(walletAddress);
    wc.on('disconnect', ()=>{ walletProvider=null; signer=null; walletAddress=null; document.getElementById('connectLabel').innerText='Connect'; });
  }catch(e){ console.error(e); alert('WalletConnect failed: '+(e.message||e)) }
}
document.getElementById('connectBtn').addEventListener('click', connectWallet);

/* Add network to MetaMask */
document.getElementById('addNetworkBtn').addEventListener('click', async ()=>{
  if (!window.ethereum) return alert('Install MetaMask to add the network');
  try{
    await window.ethereum.request({
      method:'wallet_addEthereumChain',
      params:[{
        chainId: CHAIN_ID_HEX,
        chainName: 'BitSoley',
        rpcUrls: [RPC_BASE],
        nativeCurrency: { name: 'BitSoley', symbol: SYMBOL, decimals: 18 },
        blockExplorerUrls: [ window.location.origin + getExplorerBase() ]
      }]
    });
    alert('Network added or switched in wallet');
  }catch(e){ console.error(e); alert('Add network failed: ' + (e.message||e)) }
});

/* Copy URL button */
document.getElementById('copyUrlBtn').addEventListener('click', ()=> navigator.clipboard.writeText(window.location.href).then(()=>alert('URL copied')) );

/* Parse tx hash robustly (works with /tx/ or /explorer/tx/) */
function extractHashFromPath(){
  const parts = window.location.pathname.split('/').filter(Boolean);
  // look for a segment 'tx' then next as hash
  for (let i=0;i<parts.length;i++){
    if (parts[i].toLowerCase()==='tx' && parts[i+1]) return parts[i+1];
  }
  // fallback: last segment if looks like tx
  const last = parts[parts.length-1];
  if (/^0x[0-9a-fA-F]{64}$/.test(last)) return last;
  return null;
}

const txHash = extractHashFromPath();

if (!txHash){
  document.getElementById('status').innerText = 'No transaction hash found in URL.';
} else {
  (async function loadTx(){
    try{
      document.getElementById('status').innerText = 'Fetching transaction...';
      const tx = await provider.getTransaction(txHash);
      if (!tx){ document.getElementById('status').innerText = 'Transaction not found.'; return; }
      const receipt = await provider.getTransactionReceipt(txHash);
      const blockLink = tx.blockNumber ? `${getExplorerBase()}/block/${tx.blockNumber}` : 'Pending';
      const html = `
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div style="flex:1">
            <div class="small">Hash</div><div class="mono" style="margin-top:8px">${tx.hash}</div>
            <div class="small" style="margin-top:8px">From</div><div class="mono">${tx.from}</div>
            <div class="small" style="margin-top:8px">To</div><div class="mono">${tx.to || '—'}</div>
          </div>
          <div style="width:220px;text-align:right">
            <div class="small">Value</div><div style="font-weight:800;margin-top:8px">${ethers.utils.formatEther(tx.value)} ${SYMBOL}</div>
            <div class="small" style="margin-top:10px">Gas</div><div class="mono" style="margin-top:6px">${tx.gasLimit ? tx.gasLimit.toString() : '—'}</div>
            <div style="margin-top:10px"><button id="copyTx" class="btn">Copy TX</button> <button id="openOnSite" class="btn">Open</button></div>
          </div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)"/>
        <div class="small">Receipt</div>
        <div style="margin-top:8px">${receipt ? `<div>Status: ${receipt.status ? '<span style="color:#9ef8b2">Success</span>' : '<span style="color:#ff9b9b">Fail</span>'} • Block: <a href="${blockLink}">${tx.blockNumber}</a> • GasUsed: ${receipt.gasUsed}</div>` : '<div class="mono">Pending / no receipt yet</div>'}</div>
      `;
      document.getElementById('txArea').innerHTML = html;
      document.getElementById('status').innerText = '';
      document.getElementById('copyTx').addEventListener('click', ()=> navigator.clipboard.writeText(tx.hash).then(()=>alert('TX hash copied')));
      document.getElementById('openOnSite').addEventListener('click', ()=> window.open(`${window.location.origin}${getExplorerBase()}/tx/${tx.hash}`));
    }catch(e){
      console.error('loadTx', e);
      document.getElementById('status').innerText = 'Error loading tx: ' + (e.message || e);
    }
  })();
}
</script>
</body>
</html>
