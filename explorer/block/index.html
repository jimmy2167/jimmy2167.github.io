<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BitSoley Explorer — Block</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<style>
:root{--bg1:#020217;--bg2:#061237;--accent1:#6bc8ff;--accent2:#38f9d7;--muted:#98adc0}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#e6f7ff}
.container{max-width:1000px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
.brand{font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.controls{display:flex;gap:8px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
.btn{padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.03);color:var(--accent1);font-weight:700;cursor:pointer}
.card{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
.mono{font-family:ui-monospace,monospace;color:#bfeff8}
.small{font-size:13px;color:var(--muted)}
@media(max-width:800px){ .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div><div class="brand">BitSoley Explorer</div><div class="small">Block details • RPC: <span id="rpcHost">—</span></div></div>
      <div class="controls">
        <input id="goto" placeholder="block number or hash" class="input"/>
        <button id="goBtn" class="btn">Go</button>
        <button id="connectBtn" class="btn"><i class="fa fa-wallet"></i>&nbsp;<span id="connectLabel">Connect</span></button>
        <button id="addNetworkBtn" class="btn">Add Network</button>
      </div>
    </div>

    <div id="card" class="card">
      <div id="status" class="small">Loading block...</div>
      <div id="blockArea" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
const RPC_BASE = 'https://rpc.bitsoley.com';
const CHAIN_ID_DEC = 216721;
const CHAIN_ID_HEX = '0x34e91';
const SYMBOL = 'BSO';

document.getElementById('rpcHost').innerText = (()=>{ try{return new URL(RPC_BASE).hostname}catch(e){return RPC_BASE}})();

const provider = new ethers.providers.JsonRpcProvider(RPC_BASE);
let walletProvider=null, signer=null, walletAddress=null;
const short = s => s ? (s.slice(0,8)+'…'+s.slice(-6)) : '';
const getBasePath = () => window.location.pathname.includes('/explorer/') ? '/explorer' : '';

/* wallet connect */
async function connectWallet(){ if (window.ethereum){ try{ await window.ethereum.request({method:'eth_requestAccounts'}); walletProvider = new ethers.providers.Web3Provider(window.ethereum); signer = walletProvider.getSigner(); walletAddress = await signer.getAddress(); document.getElementById('connectLabel').innerText = short(walletAddress); }catch(e){console.error(e);alert('MetaMask failed')} return;} try{ const wc = new window.WalletConnectProvider.default({ rpc: { [CHAIN_ID_DEC]: RPC_BASE }, qrcode:true }); await wc.enable(); walletProvider = new ethers.providers.Web3Provider(wc); signer = walletProvider.getSigner(); walletAddress = await signer.getAddress(); document.getElementById('connectLabel').innerText = short(walletAddress); wc.on('disconnect', ()=>{ walletProvider=null; signer=null; walletAddress=null; document.getElementById('connectLabel').innerText='Connect'; }); }catch(e){ console.error(e); alert('WalletConnect failed'); } }
document.getElementById('connectBtn').addEventListener('click', connectWallet);
document.getElementById('addNetworkBtn').addEventListener('click', async ()=>{ if (!window.ethereum) return alert('Install MetaMask'); try{ await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: CHAIN_ID_HEX, chainName:'BitSoley', rpcUrls:[RPC_BASE], nativeCurrency:{name:'BitSoley',symbol:SYMBOL,decimals:18}, blockExplorerUrls:[ window.location.origin + getBasePath() ] }]}); alert('Network added'); }catch(e){ console.error(e); alert('Add network failed'); } });

function extractBlockId(){
  const parts = window.location.pathname.split('/').filter(Boolean);
  for (let i=0;i<parts.length;i++){ if (parts[i].toLowerCase()==='block' && parts[i+1]) return parts[i+1]; }
  const last = parts[parts.length-1]; if (/^\d+$/.test(last) || /^0x[0-9a-fA-F]{64}$/.test(last)) return last; return null;
}
document.getElementById('goBtn').addEventListener('click', ()=> { const v = document.getElementById('goto').value.trim(); if (!v) return alert('Enter block number or hash'); showBlock(v); });

async function showBlock(id){
  try{
    document.getElementById('status').innerText = 'Fetching block...';
    let block = null;
    if (/^\d+$/.test(String(id))) block = await provider.getBlockWithTransactions(Number(id));
    else block = await provider.getBlockWithTransactions(id);
    if (!block){ document.getElementById('status').innerText = 'Block not found.'; document.getElementById('blockArea').innerHTML=''; return; }
    const num = (block.number !== undefined && block.number !== null) ? Number(block.number) : block.number;
    const ts = block.timestamp ? new Date(Number(block.timestamp) * 1000).toLocaleString() : '—';
    const gasUsed = block.gasUsed ? block.gasUsed.toString() : '0';
    const gasLimit = block.gasLimit ? block.gasLimit.toString() : '0';
    const txHTML = (block.transactions && block.transactions.length) ? block.transactions.map(tx => {
      const val = tx.value ? ethers.utils.formatEther(tx.value) : '0';
      return `<div style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
                <div><div class="mono">${tx.hash}</div><div class="small" style="margin-top:6px">${short(tx.from)} → ${tx.to?short(tx.to):'—'}</div></div>
                <div style="text-align:right"><div style="font-weight:800">${Number(val).toFixed(6)} ${SYMBOL}</div><div style="margin-top:6px"><button class="btn" onclick="window.location.href='${getBasePath()}/tx/${tx.hash}'">View</button></div></div>
              </div>`;
    }).join('') : '<div class="small">No transactions</div>';

    document.getElementById('blockArea').innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div style="flex:1">
          <div class="small">Block</div><div style="font-weight:800;margin-top:6px">${num}</div>
          <div class="small" style="margin-top:8px">Hash</div><div class="mono" style="margin-top:6px">${block.hash}</div>
          <div class="small" style="margin-top:8px">Timestamp</div><div style="margin-top:6px">${ts}</div>
        </div>
        <div style="width:260px;text-align:right">
          <div class="small">Miner</div><div class="mono" style="margin-top:6px">${block.miner}</div>
          <div style="margin-top:8px"><button class="btn" onclick="navigator.clipboard.writeText('${block.hash}').then(()=>alert('Copied block hash'))">Copy Hash</button>
          <button class="btn" onclick="window.open('${window.location.origin + getBasePath()}/block/${num}')">Open</button></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)"/>

      <div class="small">Summary</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px">
        <div class="small">Gas Used<div style="font-weight:800">${gasUsed}</div></div>
        <div class="small">Gas Limit<div style="font-weight:800">${gasLimit}</div></div>
        <div class="small">Tx Count<div style="font-weight:800">${(block.transactions?block.transactions.length:0)}</div></div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)"/>

      <div class="small">Transactions</div>
      <div style="margin-top:8px">${txHTML}</div>
    `;
    document.getElementById('status').innerText = '';
  }catch(e){
    console.error('showBlock', e);
    document.getElementById('status').innerText = 'Error: ' + (e.message || e);
    document.getElementById('blockArea').innerHTML = '';
  }
}

/* boot */
(function boot(){
  const id = extractBlockId();
  if (id) { document.getElementById('goto').value = id; showBlock(id); }
  else { provider.getBlockNumber().then(n => document.getElementById('status').innerText = 'Latest block: ' + n + ' — enter a block to view').catch(()=>document.getElementById('status').innerText = 'Ready'); }
})();
function extractBlockId(){ const parts = window.location.pathname.split('/').filter(Boolean); for (let i=0;i<parts.length;i++){ if (parts[i].toLowerCase()==='block' && parts[i+1]) return parts[i+1]; } const last = parts[parts.length-1]; if (/^\d+$/.test(last) || /^0x[0-9a-fA-F]{64}$/.test(last)) return last; return null; }
</script>
</body>
</html>
